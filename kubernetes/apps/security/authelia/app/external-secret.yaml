---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: authelia-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: 1password-sdk
  target:
    name: authelia-secret
    template:
      engineVersion: v2
      data:
        # Database - using dedicated authelia user
        AUTHELIA_STORAGE_POSTGRES_ADDRESS: "{{ .HOST }}"
        AUTHELIA_STORAGE_POSTGRES_DATABASE: "{{ .DATABASE_NAME }}"
        AUTHELIA_STORAGE_POSTGRES_USERNAME: "{{ .LOGIN }}"
        AUTHELIA_STORAGE_POSTGRES_PASSWORD: "{{ .PASSWORD }}"
        # Redis / Dragonfly
        AUTHELIA_SESSION_REDIS_HOST: "dragonfly.databases.svc.cluster.local"
        AUTHELIA_SESSION_REDIS_PORT: "6379"
        # Encryption keys (must be 64 hex chars each)
        AUTHELIA_STORAGE_ENCRYPTION_KEY: "{{ .storage_encryption_key }}"
        AUTHELIA_SESSION_SECRET: "{{ .session_secret }}"
        # OIDC Identity Provider (for Authelia as OIDC provider)
        AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET: "{{ .oidc_hmac_secret }}"
        AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY: |
          {{ .oidc_issuer_private_key | nindent 10 }}
        # OIDC Client for Pocket ID integration
        POCKET_ID_CLIENT_ID: "{{ .pocket_id_client_id }}"
        POCKET_ID_CLIENT_SECRET: "{{ .pocket_id_client_secret }}"
  data:
    # Import database credentials from PostgresUser-generated secret
    - secretKey: HOST
      sourceRef:
        storeRef:
          name: kubernetes
          kind: SecretStore
      remoteRef:
        key: database-authelia-user
        property: HOST
    - secretKey: DATABASE_NAME
      sourceRef:
        storeRef:
          name: kubernetes
          kind: SecretStore
      remoteRef:
        key: database-authelia-user
        property: DATABASE_NAME
    - secretKey: LOGIN
      sourceRef:
        storeRef:
          name: kubernetes
          kind: SecretStore
      remoteRef:
        key: database-authelia-user
        property: LOGIN
    - secretKey: PASSWORD
      sourceRef:
        storeRef:
          name: kubernetes
          kind: SecretStore
      remoteRef:
        key: database-authelia-user
        property: PASSWORD
  dataFrom:
    - extract:
        key: authelia
