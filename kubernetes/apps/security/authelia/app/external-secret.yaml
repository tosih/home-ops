---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: authelia-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: 1password-sdk
  target:
    name: authelia-secret
    template:
      engineVersion: v2
      data:
        # Database - using dedicated authelia user
        AUTHELIA_STORAGE_POSTGRES_ADDRESS: "{{ .HOST }}"
        AUTHELIA_STORAGE_POSTGRES_DATABASE: "{{ .DATABASE_NAME }}"
        AUTHELIA_STORAGE_POSTGRES_USERNAME: "{{ .LOGIN }}"
        AUTHELIA_STORAGE_POSTGRES_PASSWORD: "{{ .PASSWORD }}"
        # Storage encryption key
        AUTHELIA_STORAGE_ENCRYPTION_KEY: "{{ .storage_encryption_key }}"
        # Session secret
        AUTHELIA_SESSION_SECRET: "{{ .session_secret }}"
  data:
    # Import database credentials from PostgresUser-generated secret
    - secretKey: HOST
      sourceRef:
        storeRef:
          name: kubernetes
          kind: SecretStore
      remoteRef:
        key: database-authelia-user
        property: HOST
    - secretKey: DATABASE_NAME
      sourceRef:
        storeRef:
          name: kubernetes
          kind: SecretStore
      remoteRef:
        key: database-authelia-user
        property: DATABASE_NAME
    - secretKey: LOGIN
      sourceRef:
        storeRef:
          name: kubernetes
          kind: SecretStore
      remoteRef:
        key: database-authelia-user
        property: LOGIN
    - secretKey: PASSWORD
      sourceRef:
        storeRef:
          name: kubernetes
          kind: SecretStore
      remoteRef:
        key: database-authelia-user
        property: PASSWORD
  dataFrom:
    - extract:
        key: authelia
