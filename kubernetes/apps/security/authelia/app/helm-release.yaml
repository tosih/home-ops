---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authelia
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: authelia
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    domain: tosih.org
    
    ingress:
      enabled: false
    
    pod:
      kind: Deployment
      replicas: 2
      strategy:
        type: RollingUpdate
      env:
        - name: TZ
          value: America/Los_Angeles
      extraVolumeMounts:
        - name: config
          mountPath: /config
          readOnly: false
      extraVolumes:
        - name: config
          emptyDir: {}
      
      resources:
        requests:
          cpu: 10m
          memory: 128Mi
        limits:
          memory: 256Mi
    
    configMap:
      enabled: true
      theme: dark
      default_2fa_method: totp
      
      log:
        level: info
        format: json
      
      authentication_backend:
        password_reset:
          disable: false
        refresh_interval: 5m
        ldap:
          enabled: false
        file:
          enabled: true
          path: /config/users_database.yml
          watch: true
          password:
            algorithm: argon2
            argon2:
              variant: argon2id
              iterations: 3
              memory: 65536
              parallelism: 4
              key_length: 32
              salt_length: 16
      
      session:
        name: authelia_session
        same_site: lax
        expiration: 1h
        inactivity: 5m
        remember_me: 1M
        cookies:
          - domain: tosih.org
            authelia_url: https://auth.tosih.org
            default_redirection_url: https://tosih.org
        redis:
          enabled: true
          enabledSecret: true
          host: dragonfly.databases.svc.cluster.local
          port: 6379
          database_index: 0
      
      storage:
        postgres:
          enabled: true
          address: postgres17-rw.databases.svc.cluster.local
          port: 5432
          database: authelia
          schema: public
          timeout: 5s
      
      notifier:
        disable_startup_check: true
        filesystem:
          enabled: true
          filename: /config/notification.txt
      
      access_control:
        default_policy: deny
        networks:
          - name: internal
            networks:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
        rules:
          # Bypass for local networks
          - domain:
              - "*.tosih.org"
            policy: bypass
            networks:
              - internal
          # Default require authentication
          - domain:
              - "*.tosih.org"
            policy: one_factor
      
      identity_providers:
        oidc:
          enabled: true
          enabledSecret: true
          access_token_lifespan: 1h
          authorize_code_lifespan: 1m
          id_token_lifespan: 1h
          refresh_token_lifespan: 90m
          enforce_pkce: public_clients_only
          cors:
            endpoints:
              - authorization
              - token
              - revocation
              - introspection
            allowed_origins_from_client_redirect_uris: true
          clients: []
          # Clients will be added here as we integrate apps
    
    secret:
      existingSecret: authelia-secret
      
      storage:
        key: AUTHELIA_STORAGE_POSTGRES_PASSWORD
        value: ""
      
      session:
        key: AUTHELIA_SESSION_SECRET
        value: ""
      
      storageEncryptionKey:
        key: AUTHELIA_STORAGE_ENCRYPTION_KEY
        value: ""
      
      redis:
        key: AUTHELIA_SESSION_REDIS_PASSWORD
        value: ""
      
      redisSession:
        key: AUTHELIA_SESSION_REDIS_PASSWORD
        value: ""
      
      redisSentinel:
        key: AUTHELIA_SESSION_REDIS_PASSWORD
        value: ""
      
      jwt:
        key: AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET
        value: ""
      
      oidcPrivateKey:
        key: AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY
        value: ""
    
    service:
      annotations:
        gethomepage.dev/enabled: "true"
        gethomepage.dev/description: SSO & Authentication
        gethomepage.dev/group: Security
        gethomepage.dev/icon: sh-authelia.svg
        gethomepage.dev/name: Authelia
