---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: homepage
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: homepage
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      homepage:
        annotations:
          reloader.stakater.com/auto: "true"
        pod:
          securityContext:
            runAsUser: 568
            runAsGroup: 568
            runAsNonRoot: true
            fsGroup: 568
            fsGroupChangePolicy: OnRootMismatch
        initContainers:
          init-config:
            image:
              repository: ghcr.io/gethomepage/homepage
              tag: v1.10.1
            command:
              - /bin/sh
              - -c
              - |
                echo "=== Initializing config directory ==="
                echo "Syncing config files from ConfigMap..."
                cp -vf /app/config-source/* /app/config/
                echo "Config files synced"
                
                echo "Creating logs directory..."
                mkdir -p /app/config/logs
                
                echo "=== Final check ==="
                ls -la /app/config/
        containers:
          app:
            image:
              repository: ghcr.io/gethomepage/homepage
              tag: v1.10.1
            env:
              TZ: America/Los_Angeles
              HOMEPAGE_ALLOWED_HOSTS: "dashboard.tosih.org"
              PUID: "568"
              PGID: "568"
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
              startup:
                enabled: true
                spec:
                  failureThreshold: 30
                  periodSeconds: 5
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 256Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                  - ALL

    defaultPodOptions:
      automountServiceAccountToken: true

    serviceAccount:
      homepage: {}

    service:
      app:
        controller: homepage
        ports:
          http:
            port: &port 3000

    route:
      app:
        hostnames: ["dashboard.tosih.org"]
        parentRefs:
          - name: internal
            namespace: kube-system
            sectionName: https
        rules:
          - backendRefs:
              - identifier: app
                port: *port

    persistence:
      data:
        type: persistentVolumeClaim
        existingClaim: homepage-config
        globalMounts:
          - path: /app/config
      config-source:
        type: configMap
        name: homepage
        advancedMounts:
          homepage:
            init-config:
              - path: /app/config-source

    configMaps:
      config:
        enabled: true
        data:
          bookmarks.yaml: |
            - Developer:
                - Github Repo:
                    - icon: si-github
                      href: https://github.com/tosih/home-ops
                      description: Home operations repository
                - Kubernetes Docs:
                    - icon: si-kubernetes
                      href: https://kubernetes.io/docs/
                      description: Kubernetes documentation
                - Flux Docs:
                    - icon: mdi-git-commit
                      href: https://fluxcd.io/flux/
                      description: Flux CD documentation
            - Community:
                - Home Operations Discord:
                    - icon: si-discord
                      href: https://discord.gg/home-operations
                      description: Community support
                - r/selfhosted:
                    - icon: si-reddit
                      href: https://reddit.com/r/selfhosted
                      description: Self-hosting community
          docker.yaml: ""
          kubernetes.yaml: |
            mode: cluster
          services.yaml: |
            - Infrastructure:
                - Uptime Kuma:
                    icon: mdi-server
                    href: https://uptime.tosih.org
                    description: Uptime monitoring
                    namespace: default
                    app: uptime-kuma
                - AdGuard Home:
                    icon: adguard-home.svg
                    href: https://adguard.tosih.org
                    description: Network-wide ad blocking
                    namespace: network
                    app: adguard-home
                - Rook-Ceph:
                    icon: mdi-database-cluster
                    href: https://rook.tosih.org
                    description: Storage cluster dashboard
                    namespace: rook-ceph
                    app: rook-ceph-cluster
                - Goldilocks:
                    icon: mdi-scale-balance
                    href: https://goldilocks.tosih.org
                    description: Resource recommendations
                    namespace: kube-system
                    app: goldilocks

            - Home Automation:
                - Home Assistant:
                    icon: home-assistant.svg
                    href: https://home.tosih.org
                    description: Smart home automation
                    namespace: home
                    app: home-assistant
                - Homebridge:
                    icon: homebridge.svg
                    href: https://homebridge.tosih.org
                    description: HomeKit bridge
                    namespace: home
                    app: homebridge

            - Media:
                - Plex:
                    icon: plex.svg
                    href: https://plex.tosih.org
                    description: Media server
                    namespace: media
                    app: plex
                - Jellyseerr:
                    icon: jellyseerr.svg
                    href: https://requests.tosih.org
                    description: Media requests
                    namespace: media
                    app: jellyseerr
                - Sonarr:
                    icon: sonarr.svg
                    href: https://sonarr.tosih.org
                    description: TV shows management
                    namespace: media
                    app: sonarr
                - Radarr:
                    icon: radarr.svg
                    href: https://radarr.tosih.org
                    description: Movies management
                    namespace: media
                    app: radarr
                - Readarr:
                    icon: readarr.svg
                    href: https://readarr.tosih.org
                    description: Books management
                    namespace: media
                    app: readarr
                - Prowlarr:
                    icon: prowlarr.svg
                    href: https://prowlarr.tosih.org
                    description: Indexer manager
                    namespace: media
                    app: prowlarr
                - Audiobookshelf:
                    icon: audiobookshelf.svg
                    href: https://audiobooks.tosih.org
                    description: Audiobook & podcast server
                    namespace: media
                    app: audiobookshelf
                - qBittorrent:
                    icon: qbittorrent.svg
                    href: https://qbittorrent.tosih.org
                    description: Torrent client
                    namespace: media
                    app: qbittorrent
                - NZBGet:
                    icon: nzbget.svg
                    href: https://nzbget.tosih.org
                    description: Usenet downloader
                    namespace: media
                    app: nzbget
                - Beets:
                    icon: mdi-music-box-multiple
                    href: https://beets.tosih.org
                    description: Music library manager
                    namespace: media
                    app: beets

            - Cloud Apps:
                - Immich:
                    icon: immich.svg
                    href: https://photos.tosih.org
                    description: Photo management
                    namespace: cloud
                    app: immich
                - Immichframe:
                    icon: immich.svg
                    href: https://frame.tosih.org
                    description: Digital photo frame
                    namespace: cloud
                    app: immichframe
                - Linkding:
                    icon: linkding.svg
                    href: https://bookmarks.tosih.org
                    description: Bookmark manager
                    namespace: cloud
                    app: linkding
                - Memos:
                    icon: mdi-note-text
                    href: https://memos.tosih.org
                    description: Note-taking service
                    namespace: cloud
                    app: memos
                - ROMM:
                    icon: mdi-gamepad-variant
                    href: https://romm.tosih.org
                    description: ROM manager
                    namespace: cloud
                    app: romm
                - Syncthing:
                    icon: syncthing.svg
                    href: https://sync.tosih.org
                    description: File synchronization
                    namespace: cloud
                    app: syncthing

            - Security:
                - Pocket ID:
                    icon: mdi-shield-account
                    href: https://pid.tosih.org
                    description: Authentication provider
                    namespace: security
                    app: pocket-id
          settings.yaml: |
            title: Home Dashboard
            favicon: https://raw.githubusercontent.com/gethomepage/homepage/main/public/favicon.ico
            theme: dark
            color: slate
            headerStyle: clean
            target: _blank
            layout:
              Infrastructure:
                style: row
                columns: 4
              Home Automation:
                style: row
                columns: 2
              Media:
                style: row
                columns: 4
              Cloud Apps:
                style: row
                columns: 3
              Security:
                style: row
                columns: 1
          widgets.yaml: |
            - kubernetes:
                cluster:
                  show: true
                  cpu: true
                  memory: true
                  showLabel: true
                  label: "cluster"
                nodes:
                  show: true
                  cpu: true
                  memory: true
                  showLabel: true
            - search:
                provider: google
                target: _blank
