---
apiVersion: v1
kind: ConfigMap
metadata:
  name: beets-config
data:
  config.yaml: |
    # Beets configuration for organizing FLAC library
    
    # Where the organized music library will live
    # Separate from source /media/Music to avoid confusion
    directory: /media/music-library
    
    # Database location
    library: /config/musiclibrary.db
    
    # MusicBrainz autotagger configuration
    musicbrainz:
      enabled: yes
      host: musicbrainz.org
      https: yes
      ratelimit: 1
      ratelimit_interval: 1.0
      searchlimit: 5
    
    # Import settings
    import:
      copy: yes                 # Copy files (preserves originals with .cue, .log, etc.)
      write: yes                # Write tags to files (important for Plex!)
      incremental: yes          # Skip already-imported files
      quiet_fallback: skip      # Skip if no good match
      timid: no                 # Don't ask for confirmation on good matches
      none_rec_action: skip     # Skip albums with no strong recommendation
      log: /config/beet.log
      # Using 'copy' instead of 'move' preserves all extras in source folder
      # This doubles disk usage but ensures nothing is lost from What.CD rips
    
    # Plex-friendly folder structure
    paths:
      default: $albumartist/$album%aunique{}/$track $title
      singleton: Non-Album/$artist - $title
      comp: Compilations/$album%aunique{}/$track $title
    
    # Plugins for better organization
    plugins:
      - fetchart      # Download album art
      - embedart      # Embed art in FLAC files
      - duplicates    # Find duplicate files
      - replaygain    # Volume normalization
      - lastgenre     # Fetch accurate genres
      - the           # Handle "The" in artist names
      - inline        # Custom fields
      - web           # Enable web UI on port 8337
    
    # High-quality album art
    fetchart:
      auto: yes
      cautious: yes
      minwidth: 1000
      maxwidth: 0
      enforce_ratio: no
    
    # Embed art in files
    embedart:
      auto: yes
      maxwidth: 0
    
    # ReplayGain for volume normalization
    replaygain:
      auto: yes
      backend: ffmpeg
      overwrite: no
    
    # Genre fetching
    lastgenre:
      auto: yes
      source: album
    
    # Web UI configuration
    web:
      host: 0.0.0.0
      port: 8337
    
    # Handle "The" in artist names properly
    the:
      a: yes
      the: yes
      format: '{0}, {1}'
    
    # UI colors
    ui:
      color: yes
    
    # Note: Extra files (.cue, .log, artwork folders, etc.) handling
    # Unfortunately, the LinuxServer Beets image doesn't include the copyartifacts plugin.
    # Options:
    # 1. Manually copy extras after import: rsync -av --include="*.cue" --include="*.log" etc.
    # 2. Use 'copy' instead of 'move' in import settings (keeps originals)
    # 3. Build custom Beets image with copyartifacts plugin
    # 
    # For now, recommend using copy mode to preserve originals, then clean up manually later.
