---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: beets
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      beets:
        type: cronjob
        cronjob:
          schedule: "0 2 * * *"  # Daily at 2 AM
          successfulJobsHistory: 3
          failedJobsHistory: 3

        pod:
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            runAsNonRoot: true
            fsGroup: 1000
            fsGroupChangePolicy: OnRootMismatch

        containers:
          app:
            image:
              repository: lscr.io/linuxserver/beets
              tag: latest
            command:
              - /bin/bash
              - -c
              - |
                set -e
                echo "========================================="
                echo "Starting Beets import at $(date)"
                echo "Source: /media/Music/What.CD"
                echo "Destination: /media/music-library"
                echo "Mode: Quiet (-q)"
                echo "========================================="
                echo ""

                # Run the import
                beet import -q /media/Music/What.CD 2>&1 | tee /config/import-job.log

                echo ""
                echo "========================================="
                echo "Import completed at $(date)"
                echo "========================================="
                echo ""
                echo "Library Statistics:"
                beet stats

                echo ""
                echo "Log saved to: /config/import-job.log"

            env:
              TZ: America/Los_Angeles
              PUID: "1000"
              PGID: "1000"

            resources:
              requests:
                cpu: 100m
                memory: 512Mi
              limits:
                memory: 2Gi

    persistence:
      # Beets config and database
      config:
        enabled: true
        type: persistentVolumeClaim
        existingClaim: beets-config
        advancedMounts:
          beets:
            app:
              - path: /config

      # Beets configuration file
      beets-config:
        enabled: true
        type: configMap
        name: beets-config
        advancedMounts:
          beets:
            app:
              - path: /config/config.yaml
                subPath: config.yaml
                readOnly: true

      # Shared media NFS mount (same as Plex)
      media:
        enabled: true
        type: persistentVolumeClaim
        existingClaim: media-nfs
        advancedMounts:
          beets:
            app:
              - path: /media
