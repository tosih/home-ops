---
apiVersion: batch/v1
kind: Job
metadata:
  name: beets-import
  namespace: media
spec:
  # Keep job history for 7 days after completion
  ttlSecondsAfterFinished: 604800
  backoffLimit: 0  # Don't retry on failure
  template:
    metadata:
      labels:
        app: beets-import
    spec:
      restartPolicy: Never
      
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
      
      containers:
      - name: beets-import
        image: lscr.io/linuxserver/beets:latest
        command:
          - /bin/bash
          - -c
          - |
            set -e
            echo "========================================="
            echo "Starting Beets import at $(date)"
            echo "Source: /media/Music/What.CD"
            echo "Destination: /media/music-library"
            echo "Mode: Quiet (-q)"
            echo "========================================="
            echo ""
            
            # Run the import
            beet import -q /media/Music/What.CD 2>&1 | tee /config/import-job.log
            
            echo ""
            echo "========================================="
            echo "Import completed at $(date)"
            echo "========================================="
            echo ""
            echo "Library Statistics:"
            beet stats
            
            echo ""
            echo "Log saved to: /config/import-job.log"
        
        env:
          - name: TZ
            value: America/Los_Angeles
          - name: PUID
            value: "1000"
          - name: PGID
            value: "1000"
        
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 2Gi
        
        volumeMounts:
          - name: config
            mountPath: /config
          - name: beets-config
            mountPath: /config/config.yaml
            subPath: config.yaml
            readOnly: true
          - name: media
            mountPath: /media
      
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: beets-config
        - name: beets-config
          configMap:
            name: beets-config
        - name: media
          persistentVolumeClaim:
            claimName: media-nfs
